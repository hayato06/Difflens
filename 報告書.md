# 開発作業報告書

## 2026-01-13: プロジェクト初期構築とコア機能の実装

### 1. プロジェクトのセットアップ
- **環境構築**:
  - `package.json`: プロジェクトのメタデータと依存関係を定義しました。
  - `tsconfig.json`: TypeScriptのコンパイル設定を行いました。
  - `Dockerfile`: Playwrightを含む一貫したレンダリング環境用のDocker設定を作成しました。
  - `.gitignore`: 不要なファイルをGit管理から除外する設定を追加しました。
- **依存関係のインストール**:
  - `playwright`, `pixelmatch`, `cac`, `tsup` などの主要ライブラリをインストールしました。

### 2. CLIツールの実装 (`src/cli.ts`)
- `cac` ライブラリを使用して、CLIの基本構造を作成しました。
- 以下のコマンドを実装しました：
  - `init`: 設定ファイル (`difflens.config.ts`) の雛形を生成します。
  - `test`: テストを実行し、差分があれば終了コード1を返します（CI対応）。
  - `report`: レポート生成（現在は `test` コマンドに統合）。

### 3. コア機能の実装
- **スクリーンショット撮影 (`src/core/capture.ts`)**:
  - Playwrightを使用して、指定されたURLのスクリーンショットを撮影する機能を実装しました。
  - フォントの読み込み待機やアニメーションの無効化処理を含めました。
- **画像比較 (`src/core/compare.ts`)**:
  - `pixelmatch` を使用して、2つの画像の差分を検出する機能を実装しました。
- **アクセシビリティ診断 (`src/core/a11y.ts`)**:
  - `@axe-core/playwright` を使用して、ページロード時にアクセシビリティの問題を自動検出する機能を実装しました。
- **テストランナー (`src/core/runner.ts`)**:
  - **ベースライン管理**: 初回実行時は画像をベースラインとして保存し、2回目以降は比較を行います。
  - **HTMLレポート生成**: テスト完了後に `.difflens/index.html` を生成し、結果を可視化します。

### 4. 設定ファイル読み込み機能 (`src/config.ts`)
- ユーザーが `difflens.config.ts` (TypeScript) で設定を書けるようにしました。
- `esbuild` を使用して、実行時にTypeScriptの設定ファイルをトランスパイルして読み込む仕組みを実装しました。

### 5. ドキュメント整備
- **README.md**: インストール方法、使い方、設定オプションの解説を作成しました。
- **CONTRIBUTING.md**: 開発者向けの貢献ガイドを作成しました。

---

## 機能詳細・動作原理 (Technical Deep Dive)

### 1. スクリーンショット撮影 (`src/core/capture.ts`)
Playwrightの `page.screenshot()` メソッドを使用していますが、単に撮影するだけでなく、**再現性（Flakinessの排除）**を高めるための工夫を組み込んでいます。

*   **フォント読み込み待機**: `document.fonts.ready` プロミスを解決待ちすることで、Webフォントが完全に読み込まれてから撮影します。
*   **アニメーション無効化**: CSSをページに注入し、すべての要素の `animation-duration` と `transition-duration` を `0s` に強制します。
*   **セレクタの隠蔽/マスク**: オプションで指定された要素を隠蔽またはマスクする機能（実装済み）。

### 2. 画像比較 (`src/core/compare.ts`)
`pixelmatch` ライブラリを中心としたピクセル単位の比較を行っています。

*   **ピクセルマッチング**: 2つの画像（ベースラインと現在の画像）のRGBA値をピクセルごとに比較します。
*   **アンチエイリアス無視**: `pixelmatch` の機能により、レンダリングエンジンの微妙な差異による誤検知を減らしています。
*   **差分画像生成**: 差分があったピクセルを強調した画像を生成します。

### 3. アクセシビリティ診断 (`src/core/a11y.ts`)
`@axe-core/playwright` を使用して、ブラウザ内で `axe-core` エンジンを実行しています。

*   **DOM解析**: 現在のページのDOMツリーを走査し、WCAG基準に基づいて違反をチェックします。
*   **結果の統合**: 視覚的テストと同じタイミングで実行され、レポートに統合されます。

### 4. 設定ファイルの動的読み込み (`src/config.ts`)
Node.js環境でTypeScriptの設定ファイルを直接読み込むための仕組みです。

*   **JITトランスパイル**: 実行時に `esbuild` を呼び出し、`.ts` ファイルを一時的な `.mjs` ファイルにトランスパイルします。
*   **Dynamic Import**: トランスパイルされたJSファイルを `import()` 関数で動的に読み込みます。

### 5. テストランナーのオーケストレーション (`src/core/runner.ts`)
全体のフローを制御します。

1.  **ブラウザ起動**: PlaywrightでChromiumブラウザを起動します。
2.  **シナリオ実行**: 設定ファイルに記述された各シナリオについて、撮影と診断を実行します。
3.  **ベースライン比較**:
    *   初回: 撮影画像を `.difflens/baseline` に保存。
    *   2回目以降: 撮影画像を `.difflens/current` に保存し、ベースラインと比較。差分があれば `.difflens/diff` に保存。
4.  **レポート生成**: 結果を集計し、HTMLレポートを出力します。

---

## 視覚的回帰テストの概念 (Concept of Visual Regression Testing)

### 1. なぜ画像比較を行うのか？
Webアプリケーションの更新時に、**「意図しない変化（リグレッション）」を機械的に検知すること**が目的です。人間が全ページを目視チェックするコストとリスクを削減します。

### 2. 「完成図」は必要か？（ベースラインの考え方）
**結論: 事前に完璧な完成図は不要です。**

視覚的回帰テストでは、**「過去の正常な状態（ベースライン）」**と**「現在の状態」**を比較します。
初回実行時に撮影された画像を「正解」とし、以降の変更を監視します。意図的な変更（デザインリニューアル等）があった場合は、その新しい状態を新たなベースラインとして更新（承認）します。

## 2026-01-14: Phase 2 - AI Optimization & SaaS Prototype

### 1. SaaSコンセプト策定 (`SaaS_Concept.md`)
- **ビジョン**: "Visual Regression Testing for Everyone" + "Accessibility as a Service"
- **ターゲット**: AIコーディングエージェント（v0, Lovable等）をPrimaryターゲットに設定。
- **戦略**: AIが自律的に修正を行えるようにするための「Prompt-Ready Output」や「MCP Server」を提供する。

### 2. Prompt-Ready Output の実装
- **目的**: AIエージェントがDiffLensの出力を理解しやすくする。
- **実装内容**:
  - CLIに `--format` オプションを追加 (`default`, `json`, `ai`)。
  - `ai` フォーマット: AIへのプロンプトに貼り付けやすい、コンテキストを含んだテキスト形式を出力。
  - `json` フォーマット: 構造化データを出力し、プログラムによる解析を容易にする。

### 3. MCP Server の実装
- **目的**: Claude DesktopなどのAIエージェントからDiffLensを直接呼び出せるようにする。
- **実装内容**:
  - `src/mcp-server.ts`: MCPサーバーのエントリーポイントを作成。
  - `difflens_check` ツールを定義: URLを受け取り、CLIを内部的に呼び出してAIフォーマットの結果を返す。
  - `child_process` を使用してCLIを実行することで、依存関係の競合やバンドル問題を回避し、安定性を確保。
  - CLIに `--url` オプションを追加し、設定ファイルなしでアドホックなテストを実行可能にした。

### 4. API Server Prototype の実装
- **目的**: SaaS化に向けた技術検証。REST API経由でDiffLensを利用可能にする。
- **実装内容**:
  - `src/api-server.ts`: Honoを使用した軽量APIサーバー。
  - `POST /check`: URLとラベルを受け取り、CLIを実行して結果をJSONで返す。
  - MCPサーバーと同様に `child_process` 方式を採用し、CLIの機能をそのままAPIとして公開することに成功。

### 5. Phase 3: Refinement & Security (レビュー対応)
- **Critical Fixes**:
  - 画像の寸法不一致時およびアクセシビリティ違反検出時に、テストを明示的にFailさせ、終了コード1を返すように修正。
- **CLI Output Stabilization**:
  - `--format json` および `--format ai` 指定時に、進捗ログを標準エラー出力(stderr)に分離し、標準出力(stdout)には純粋な結果のみを出力するように改善。これにより、パイプライン処理でのパースエラーを防止。
- **Security Hardening**:
  - MCP/APIサーバーでのCLI呼び出しを `exec` から `execFile` に変更し、引数を配列として渡すことでコマンドインジェクション脆弱性を解消。
- **Feature Enhancements**:
  - **Viewports**: シナリオごとに複数のビューポート（PC/SPなど）でのテストをサポート。
  - **Actions**: スクリーンショット撮影前にクリックや入力、待機などのアクションを実行可能に。これにより、ログイン後のページや動的なUIのテストが可能になった。

---

## 2026-01-18: Phase 4 - npm公開準備の完了

### 概要
DiffLensをnpm公開可能な状態に完成させました。

### 実施内容

#### Phase 1: 必須タスク

| タスク | ファイル | 内容 |
|--------|----------|------|
| LICENSE作成 | `LICENSE` | MITライセンステキストを新規作成 |
| package.json修正 | `package.json` | `files`, `engines`フィールドを追加 |
| APIレスポンス形式統一 | `src/api-server.ts` | `{ success, result }` → `{ success, results: [] }` に修正（READMEとの整合性確保） |
| 型エクスポート | `src/index.ts` | 型とコア関数のエクスポートファイルを新規作成 |
| ビルド設定更新 | `tsup.config.ts` | `src/index.ts`をエントリーポイントに追加 |
| ユニットテスト追加 | `tests/unit/*.test.ts` | 3ファイル追加（config, types, ai-reporter） |
| CI/CD設定 | `.github/workflows/ci.yml` | Node.js 18/20/22でのビルド・テスト自動化 |

#### Phase 2: 推奨タスク

| タスク | ファイル | 内容 |
|--------|----------|------|
| 変更履歴作成 | `CHANGELOG.md` | v0.0.1の変更履歴を記載 |
| npm除外設定 | `.npmignore` | src/, tests/, 設定ファイル等を除外 |

### 最終仕様

#### パッケージ情報

```json
{
  "name": "difflens",
  "version": "0.0.1",
  "description": "Visual Regression Testing & Accessibility Auditing Tool",
  "license": "MIT",
  "engines": { "node": ">=18.0.0" },
  "files": ["dist", "README.md", "LICENSE"]
}
```

#### エクスポートされる型・関数

```typescript
// 型
export type {
  DiffLensConfig,  // 設定オブジェクトの型
  Viewport,        // ビューポート定義
  Action,          // アクション定義（click, type, wait）
  Scenario,        // テストシナリオ定義
  TestResult,      // テスト結果
  ReportData,      // レポートデータ
} from './types';

// 関数
export { loadConfig, DEFAULT_CONFIG } from './config';
export { runTests } from './core/runner';
export { formatAiReport } from './core/reporters/ai-reporter';
```

#### APIレスポンス形式（統一後）

```json
{
  "success": true | false,
  "results": [
    {
      "scenario": "string",
      "status": "pass" | "fail" | "new",
      "diffPixels": 0,
      "diffPercentage": 0,
      "dimensionMismatch": false,
      "a11yViolations": []
    }
  ]
}
```

#### ビルド出力

| ファイル | 形式 | 用途 |
|----------|------|------|
| `dist/index.js` | CJS | ライブラリとしてのメインエントリー |
| `dist/index.mjs` | ESM | ESモジュール版 |
| `dist/index.d.ts` | DTS | TypeScript型定義 |
| `dist/cli.js` | CJS | CLIツール |
| `dist/api-server.js` | CJS | REST APIサーバー |
| `dist/mcp-server.js` | CJS | MCPサーバー |

### テスト結果

```
 Test Files  5 passed (5)
      Tests  25 passed (25)
```

| テストファイル | テスト数 | 内容 |
|----------------|----------|------|
| `tests/unit/types.test.ts` | 11 | 型定義の検証 |
| `tests/unit/ai-reporter.test.ts` | 5 | AIレポーターの出力検証 |
| `tests/unit/config.test.ts` | 5 | 設定読み込みの検証 |
| `tests/unit/compare.test.ts` | 3 | 画像比較の検証 |
| `tests/e2e/smoke.test.ts` | 1 | E2Eスモークテスト |

### パッケージサイズ

```
npm notice package size:  27.3 kB
npm notice unpacked size: 117.4 kB
npm notice total files:   22
```

### npm公開前の残作業

以下は手動で設定が必要です：

1. **package.json**
   - `author`: 作者情報を設定
   - `repository`: GitHubリポジトリURLを設定

2. **GitHub設定**
   - `NPM_TOKEN`シークレットを追加
   - `.github/workflows/ci.yml`のpublishジョブをコメント解除

3. **公開コマンド**
   ```bash
   npm publish
   ```

### 新規作成・修正ファイル一覧

```
/workspaces/副業/
├── LICENSE                          # 新規作成（MIT）
├── CHANGELOG.md                     # 新規作成
├── .npmignore                       # 新規作成
├── .github/
│   └── workflows/
│       └── ci.yml                   # 新規作成
├── src/
│   ├── index.ts                     # 新規作成（エクスポート）
│   └── api-server.ts                # 修正（レスポンス形式）
├── tests/
│   └── unit/
│       ├── config.test.ts           # 新規作成
│       ├── types.test.ts            # 新規作成
│       └── ai-reporter.test.ts      # 新規作成
├── package.json                     # 修正（files, engines追加）
└── tsup.config.ts                   # 修正（index.ts追加）
```

### 検証結果

| 検証項目 | 結果 |
|----------|------|
| ビルド (`npm run build`) | 成功 |
| テスト (`npm test`) | 25/25 パス |
| パッケージ内容 (`npm pack --dry-run`) | 22ファイル, 27.3KB |
| CLI動作 (`node dist/cli.js --help`) | 正常動作 |

**結論**: DiffLensはnpm公開可能な状態に完成しました。

---

## 2026-01-18: Phase 5 - npm公開準備（Git/GitHub設定）

### 実施内容

| タスク | 状態 | 詳細 |
|--------|------|------|
| Git初期化 | 完了 | リポジトリ初期化、.gitignore更新 |
| package.json更新 | 完了 | exports, repository, bugs, homepage追加 |
| READMEバッジ追加 | 完了 | npm, CI, License, Node.jsバッジ |
| GitHubテンプレート | 完了 | Issue/PRテンプレート作成 |
| npm公開検証 | 完了 | `npm pack --dry-run` 成功 |
| 初回コミット | 完了 | 44ファイル、6958行 |

### 更新されたpackage.json

```json
{
  "exports": {
    ".": {
      "types": "./dist/index.d.ts",
      "import": "./dist/index.mjs",
      "require": "./dist/index.js"
    }
  },
  "repository": {
    "type": "git",
    "url": "git+https://github.com/your-username/difflens.git"
  },
  "bugs": {
    "url": "https://github.com/your-username/difflens/issues"
  },
  "homepage": "https://github.com/your-username/difflens#readme"
}
```

### 新規作成ファイル

| ファイル | 用途 |
|----------|------|
| `.github/ISSUE_TEMPLATE/bug_report.md` | バグ報告テンプレート |
| `.github/ISSUE_TEMPLATE/feature_request.md` | 機能要望テンプレート |
| `.github/PULL_REQUEST_TEMPLATE.md` | PRテンプレート |

### 次のステップ

1. **手動設定が必要**:
   - `your-username` を実際のGitHubユーザー名に置換
   - `git config user.email` / `user.name` を設定

2. **GitHub公開手順**:
   ```bash
   # リモートリポジトリを追加
   git remote add origin https://github.com/YOUR_USERNAME/difflens.git

   # mainブランチにリネーム
   git branch -M main

   # プッシュ
   git push -u origin main
   ```

3. **npm公開手順**:
   ```bash
   # npmにログイン
   npm login

   # 公開
   npm publish
   ```
