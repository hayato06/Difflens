# DiffLens プロジェクトレビュー

## 1. プロジェクト概要

**DiffLens**は、Playwrightベースの視覚的回帰テスト（Visual Regression Testing）およびアクセシビリティ監査ツールです。

### コンセプト
- "Visual Regression Testing for Everyone" + "Accessibility as a Service"
- 既存の高額な商用ツール（Applitools等）やセットアップが面倒なOSS（BackstopJS等）の代替を目指す

### 主なターゲット
- AIコーディングエージェント（v0, Lovable, Bolt.new等）
- フロントエンド/QAエンジニア
- スタートアップ〜中規模開発チーム

---

## 2. 実装済み機能

### CLI（`src/cli.ts`）
| コマンド | 説明 |
|----------|------|
| `init` | 設定ファイル`difflens.config.ts`を生成 |
| `test` | 視覚的回帰テストとa11y監査を実行 |
| `report` | HTMLレポート生成（現在はtestに統合） |

**オプション:**
- `--url <url>`: 特定URLに対するアドホックテスト
- `--label <label>`: シナリオのラベル指定
- `--format <type>`: 出力形式（default/json/ai）

### コア機能（`src/core/`）

| モジュール | 機能 |
|------------|------|
| `runner.ts` | テスト実行のメインロジック |
| `capture.ts` | スクリーンショット撮影（フォント待機、アニメーション無効化対応） |
| `compare.ts` | pixelmatchによる画像差分検出 |
| `a11y.ts` | axe-coreによるアクセシビリティ監査 |
| `report.ts` | HTMLレポート生成 |

### サーバー機能

| サーバー | 説明 |
|----------|------|
| MCPサーバー | Model Context Protocol対応。AIエージェントから`difflens_check`ツールとして呼び出し可能 |
| REST API | Honoベース。`POST /check`エンドポイントでテスト実行 |

### 設定オプション（`DiffLensConfig`）

```typescript
interface DiffLensConfig {
  baseUrl?: string;           // ベースURL
  viewports?: { [key: string]: { width: number; height: number } };
  scenarios: Scenario[];      // テストシナリオ
  threshold?: number;         // 画像比較の閾値（0-1）
  outDir?: string;            // 出力ディレクトリ
  format?: 'default' | 'json' | 'ai';
  failOnActionError?: boolean;
  failOnNavigationError?: boolean;
}
```

---

## 3. アーキテクチャ評価

### 良い点

1. **モジュール設計**: 機能ごとに適切に分離されており、保守性が高い
2. **型安全性**: TypeScriptの型定義が充実（`src/types.ts`）
3. **エラーハンドリング**: リトライ機構、ナビゲーション失敗時のフォールバック実装
4. **テスト基盤**: ユニットテスト（vitest）とE2Eテストの両方が存在
5. **Zero Config志向**: デフォルト値が適切に設定されており、最小構成で動作可能
6. **AI統合**: MCP対応により、AIエージェントから直接呼び出し可能

### 技術スタック

| 分類 | 技術 |
|------|------|
| 言語 | TypeScript |
| ブラウザ自動化 | Playwright |
| 画像比較 | pixelmatch + pngjs |
| アクセシビリティ | @axe-core/playwright |
| CLI | cac |
| API | Hono |
| MCP | @modelcontextprotocol/sdk |
| バリデーション | Zod |
| ビルド | tsup |
| テスト | vitest |

---

## 4. コード品質分析

### `src/core/runner.ts`（225行）

**評価: B+**

- リトライロジックが適切に実装されている
- ビューポート対応、アクション実行が柔軟
- 複数の出力形式（HTML/JSON/AI）をサポート

**改善点:**
- 関数が長い（225行）ため、一部ロジックの抽出を検討
- `console.error`の使用が多く、ログレベルの統一が望ましい

### `src/core/capture.ts`（51行）

**評価: A**

- コンパクトで単一責任
- フォント待機、アニメーション無効化を適切に実装
- マスク/非表示セレクタに対応

### `src/core/compare.ts`（50行）

**評価: A**

- シンプルで理解しやすい
- 寸法不一致の検出対応
- 差分率の計算も実装

### `src/core/a11y.ts`（27行）

**評価: A**

- axe-coreの統合がシンプル
- 違反内容のログ出力が見やすい

---

## 5. テストカバレッジ

### 現状

| テスト種別 | ファイル | カバー範囲 |
|------------|----------|------------|
| ユニット | `compare.test.ts` | 画像比較の基本ケース（同一画像、寸法不一致、ピクセル差分） |
| E2E | `smoke.test.ts` | 基本的なテスト実行とアーティファクト生成 |

### 不足しているテスト

1. `failOnNavigationError`/`failOnActionError`のON/OFF挙動
2. アクセシビリティ違反の検出ケース
3. JSON/AI出力形式の検証
4. MCPサーバー/APIサーバーの統合テスト
5. エッジケース（設定なし、空シナリオ等）

---

## 6. ドキュメント整合性

### 問題点

| 箇所 | 問題 |
|------|------|
| README.md | APIレスポンススキーマが`{ results: [...] }`と記載されているが、実装は`{ success, result }`形式 |
| オプション説明 | `failOnActionError`/`failOnNavigationError`のデフォルト値（false）が明記されていない |

### 推奨対応

1. READMEのAPIスキーマを実装に合わせて修正
2. 設定オプションのデフォルト値を明示
3. 設定例を追加

---

## 7. セキュリティ考慮

- **問題なし**: コードにセキュリティ上の脆弱性は見当たらない
- URLは検証されている（Zodスキーマ）
- ファイル操作は出力ディレクトリに限定

---

## 8. 改善提案（優先度順）

### 高優先度

1. **README/API整合**: ドキュメントと実装のレスポンス形式を統一する
2. **テスト拡充**: 失敗ケース（a11y違反、寸法不一致、ナビゲーション失敗）のテストを追加
3. **CI/CD**: GitHub Actionsでテスト自動実行を設定

### 中優先度

4. **ログ統一**: `console.error`を構造化ログに置き換え
5. **runner.ts分割**: 長い関数を小さな関数に分割
6. **エラーメッセージ改善**: ユーザーフレンドリーなメッセージに

### 低優先度

7. **設定バリデーション**: Zodによる設定ファイルの検証
8. **プログレス表示**: 長時間テスト実行時の進捗表示
9. **並列実行**: 複数シナリオの並列処理

---

## 9. SaaS化に向けた課題

`SaaS_Concept.md`に記載のロードマップに基づく課題:

| フェーズ | 課題 |
|----------|------|
| MVP | GitHub App連携、S3画像アップロード、Webダッシュボード |
| Collaboration | コメント機能、Slack/Teams通知、複数ブラウザ対応 |
| Advanced | Figma連携、AI差分判定、時系列グラフ |

**技術的課題:**
- クラウドレンダリング基盤（Playwrightの並列実行環境）の構築
- 従量課金APIの認証・課金システム

---

## 10. 総合評価

| 項目 | 評価 |
|------|------|
| コード品質 | B+ |
| アーキテクチャ | A- |
| テストカバレッジ | C+ |
| ドキュメント | B |
| 将来性 | A |

### 総評

DiffLensは、視覚的回帰テストとアクセシビリティ監査を統合した実用的なツールです。Phase 1（CLI & OSS）の主要機能は概ね実装完了しており、特にMCP対応によるAIエージェント統合は差別化ポイントとして有望です。

テストカバレッジの拡充とドキュメント整合性の改善を行えば、npm公開可能な品質に達すると考えられます。SaaS化に向けてはクラウドインフラの設計が次のステップとなります。

---

*レビュー実施日: 2026-01-18*
